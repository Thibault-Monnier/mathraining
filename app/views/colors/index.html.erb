<% provide(:title, 'Niveaux et couleurs') %>

<h1><%= title_1("Niveaux et couleurs") %></h1>

<% i = 1 %>

<table>
  <tr><th></th><th class="p-1">Seuil</th><th class="p-1">Nom</th><th class="p-1">Nom féminin</th><th class="p-1">Couleur</th><th></th><th></th></tr>
  <% Color.order(:pt).each do |c| %>
    <tr>
      <td class="ps-2 pe-1"><%= i %>.</td>
      <%= form_for(c) do |f| %>
        <td><%= f.number_field :pt, :id => "pt_edit#{i}", :class => "form-control m-0", :style => "width:85px;"%></td>
        <td><%= f.text_field :name, :id => "name_edit#{i}", :class => "form-control m-0", :maxlength => "255", :style => "width:150px;"%></td>
        <td><%= f.text_field :femininename, :id => "femininename_edit#{i}", :class => "form-control m-0", :maxlength => "255", :style => "width:150px;"%></td>
        <td><%= f.text_field :color, :id => "color_edit#{i}", :class => "form-control m-0 fw-bold", :maxlength => "7", :style => "width:95px; color:#{c.color};" %></td>
        <td><%= f.submit "Modifier", :id => "button_edit#{i}", class: "btn btn-primary ms-2", onclick: "return confirm('Êtes-vous sûr de vouloir modifier ce niveau ?')" %></td>
        <% i = i+1 %>
      <% end %>
      <td class="ps-3"><%= link_to "Supprimer", c, method: :delete, id: "link_delete#{i}", data: { confirm: "Êtes-vous sûr de vouloir supprimer ce niveau ?" } %> </td>
    </tr>
  <% end %>

  <tr>
    <td class="pt-2"></td>
    <%= form_for(:color) do |f| %>
      <td class="pt-2"><%= f.number_field :pt, :id => "pt_add", :class => "form-control m-0", :style => "width:85px;"%></td>
      <td class="pt-2"><%= f.text_field :name, :id => "name_add", :class => "form-control m-0", :maxlength => "255", :style => "width:150px;"%></td>
      <td class="pt-2"><%= f.text_field :femininename, :id => "femininename_add", :class => "form-control m-0", :maxlength => "255", :style => "width:150px;" %></td>
      <td class="pt-2"><%= f.text_field :color, :id => "color_add", :class => "form-control m-0", :maxlength => "7", :style => "width:95px;" %></td>
      <td class="pt-2"><%= f.submit "Ajouter", :id => "button_add", class: "btn btn-primary ms-2",  onclick: "return confirm('Êtes-vous sûr de vouloir ajouter ce niveau ?')" %></td>
    <% end %>
  </tr>

</table>

<br/><br/>

<!-- Graphique pour visualiser les couleurs -->

<center>
  <div style="width:850px; height:450px; position:relative;">
    <canvas id="myCanvas" width="806" height="450" style="position:absolute; left:30px; top: 0px;">
      Votre navigateur ne supporte pas les canvas.
    </canvas>

    <% @niveaux = Color.order(:pt).all %>

    <% nombrelevel = 0 %>
    <% maxi = 0 %>

    <% @niveaux.each do |n| %>
      <% maxi = 1 + n.pt * 1.2 %>
      <% nombrelevel = nombrelevel+1 %>
    <% end %>

    <% i = 1 %>

    <% prec = 2000 %>

    <% @niveaux.each do |n| %>
      <% if i > 1 %>
        <% haut = [450 - 450*(n.pt/maxi), 0].max %>
        <% if haut > 0 %>
          <% if haut < prec - 12 %>
            <div class="text-right" style="position:absolute; top:<%= haut-8 %>px; right:828px; width:30px;"><%= n.pt %></div>
            <% prec = haut %>
          <% end %>
        <% end %>
      <% end %>
      <% i = i+1 %>
    <% end %>

  </div>
</center>

<script>
var c=document.getElementById("myCanvas");
var ctx=c.getContext("2d");

<% i = 1 %>
<% @niveaux.each do |n| %>
  <% if i == nombrelevel %>
    <% bas = [450 - 450*(n.pt/maxi), 0].max %>
    <% haut = 0 %>
  <% else %>
    <% bas = [450 - 450*(n.pt/maxi), 0].max %>
    <% haut = [450 - 450*(@niveaux[i].pt/maxi), 0].max %>
  <% end %>
  <% if bas > haut %>
    ctx.beginPath();
    ctx.rect(0, <%= haut %>, 806, <%= bas - haut %>);
    ctx.fillStyle = '<%= n.color %>';
    ctx.fill();
  <% end %>
  <% i = i+1 %>
<% end %>

// Contour du canvas
ctx.beginPath();
ctx.rect(1*0, 1*0, 1*806, 1*450);
ctx.lineWidth = 2;
ctx.strokeStyle = 'black';
ctx.stroke();
</script>
