<% total_waiting = 180 %>
<% if !solvedquestion.nb_guess.nil? && solvedquestion.nb_guess >= 3 && DateTime.now < solvedquestion.resolution_time + total_waiting %>
  <% needtowait = true %>
<% else %>
  <% needtowait = false %>
<% end %>

<% if !question.is_qcm %>
  <!-- pas QCM -->
  <% val = nil %>
  <% if question.decimal %>
    <p class="mt-3">On demande une réponse <b>décimale</b>, arrondie au millième près.</p>
    <% val = solvedquestion.guess %>
  <% else %>
    <p class="mt-3">On demande une réponse <b>entière</b>.</p>
    <% val = solvedquestion.guess.to_i if !solvedquestion.guess.nil? %>
  <% end %>

  <%= form_for(solvedquestion) do |g| %>
    <input type="hidden" name="question_id" value="<%= question.id %>" />
    <div class="mb-2">
    <%= g.label :guess, :class => "form-label to-enable", :disabled => !@signed_in || current_user.other || needtowait %>
    <%= g.text_field :guess, class: "form-control to-enable ms-1", style: "width:70px;", value: val, :disabled => !@signed_in || current_user.other || needtowait %>
    </div>
    <%= g.submit "Soumettre", class: "btn btn-primary to-enable", :disabled => !@signed_in || current_user.other || needtowait %>
  <% end %>
  
<% else %>
  <!-- QCM -->
  <% anciens = solvedquestion.items %>
  <% if question.many_answers %>
    <%= form_for solvedquestion do |x| %>
      <p class="mt-3 mb-3 fw-bold">Cochez chaque proposition correcte.</p>
      <input type="hidden" name="question_id" value="<%= question.id %>" />
      <% question.items.order(:position).each do |c| %>
        <div class="form-check mb-2">
          <label class="form-check-label ms-2">
            <input class="form-check-input to-enable" type="checkbox" id="ans[<%= c.id %>]" name="ans[<%= c.id %>]" value="ok" <%= "checked" if anciens.exists?(:id => c.id) %> <%= "disabled=\"true\"" if !@signed_in || current_user.other || needtowait %>>
            <%= raw(c.ans) %>
          </label>
        </div>
      <% end %>
      <button class="btn btn-primary to-enable mt-3" type="submit" <%= "disabled=\"true\"" if !@signed_in || current_user.other || needtowait %>>Soumettre</button>
    <% end %>
  <% else %>
    <% item = solvedquestion.items.first %>
    <div class="mb-3"></div>
    <%= form_for solvedquestion do |x| %>
      <input type="hidden" name="question_id" value="<%= question.id %>" />
      <% question.items.order(:position).each do |c| %>
        <div class="form-check mb-2">
          <label class="form-check-label ms-2">
            <input class="form-check-input to-enable" type="radio" id="ans[<%= c.id %>]" name="ans" value="<%= c.id %>" <%= "checked" if !item.nil? && c.id == item.id %> <%= "disabled=\"true\"" if !@signed_in || current_user.other || needtowait %>>
            <%= raw(c.ans) %>
          </label>
        </div>
      <% end %>
      <button class="btn btn-primary to-enable mt-3" type="submit" <%= "disabled=\"true\"" if !@signed_in || current_user.other || needtowait %>>Soumettre</button>
    <% end %>

  <% end %>
<% end %>

<% if !solvedquestion.nb_guess.nil? %>
  <p class="mt-3 text-color-red">Votre réponse <%= ("(<b>" + val.to_s + "</b>)").html_safe if !question.is_qcm %> est erronée. Vous avez déjà commis <b><%= solvedquestion.nb_guess %></b> erreur<%= "s" if solvedquestion.nb_guess > 1 %>.</p>
  
  <p class="text-color-red">À partir de la troisième erreur, vous devez attendre trois minutes avant chaque nouvelle tentative.</p>
  
  <% if needtowait %>
    <%= render 'questions/waiting', solvedquestion: solvedquestion, total_waiting: total_waiting %>
  <% end %>
  
<% end %>
