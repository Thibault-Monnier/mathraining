<% provide(:title, 'Fréquentation du site') %>

<% mois = ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"] %>
<% colors = ["#FFFFBB", "#FFBBBB", "#FFDD77", "#A0FFA0", "#AAF5FF", "#D8D8FF"] %>

<% t1 = Time.now %>

<!-- Test pour la performance -->
<% montretemps = 0 %>
<% if(params.has_key?:montretemps) %>
  <% montretemps = params[:montretemps].to_i %>
<% end %>

<h1>Statistiques diverses</h1>

<h3>Fréquentation du site</h3>

Le graphique suivant reprend le nombre d'utilisateurs connectés chaque jour sur le site, depuis le 19 mars 2015.<br/><br/>

<center>
<!-- Endroit pour dessiner la fréquentation -->
<div id="contenant1" style="width:100%; max-width:900px; height:480px; position:relative; display:block;">
<canvas id="myCanvas1" width="900" height="480" style="position:absolute; left:0px; top: 0px;">
Votre navigateur ne supporte pas les canvas.
</canvas>
</div>
</center>

<h3>Résolutions d'exercices</h3>

Ci-dessous, le nombre d'exercices résolus par semaine depuis le lancement du site, le 8 décembre 2014.<br/><br/>

<center>
<!-- Endroit pour dessiner la fréquentation -->
<div id="contenant2" style="width:100%; max-width:900px; height:480px; position:relative; display:block;">
<canvas id="myCanvas2" width="900" height="480" style="position:absolute; left:0px; top: 0px;">
Votre navigateur ne supporte pas les canvas.
</canvas>
</div>
</center>

<h3>Soumissions aux problèmes</h3>

Ci-dessous, le nombre de soumissions par semaine depuis le lancement du site, le 8 décembre 2014.<br/><br/>

<center>
<!-- Endroit pour dessiner la fréquentation -->
<div id="contenant3" style="width:100%; max-width:900px; height:480px; position:relative; display:block;">
<canvas id="myCanvas3" width="900" height="480" style="position:absolute; left:0px; top: 0px;">
Votre navigateur ne supporte pas les canvas.
</canvas>
</div>
</center>

<% @premierlundi = Date.parse('8-12-2014') %>

<% def convert_date(courant) %>
  <% d = "" %>
  <% d = d+"0" if courant.day < 10 %>
  <% d = d+courant.day.to_s + "/" %>
  <% d = d + "0" if courant.month < 10 %>
  <% d = d + courant.month.to_s + "/" %>
  <% d = d + "0" if (courant.year % 2000) < 10 %>
  <% d = d + (courant.year % 2000).to_s %>
  <% return d; %>
<% end %>

<% def convert_to_week(courant) %>
  <% return ((courant-@premierlundi).to_i/7).floor %>
<% end %>

<% def ruby_to_javascript(arr) %>
  <% t = "[" %>
  <% prems = true %>
  <% arr.each do |a| %>
    <% t = t + "," if !prems %>
    <% prems = false %>
    <% t = t + a.to_s %>
  <% end %>
  <% t = t + "]" %>
  <% return t.html_safe %>
<% end %>

<% def ruby_to_javascript_string(arr) %>
  <% t = "[" %>
  <% prems = true %>
  <% arr.each do |a| %>
    <% t = t + "," if !prems %>
    <% prems = false %>
    <% t = t + "'" + a + "'" %>
  <% end %>
  <% t = t + "]" %>
  <% return t.html_safe %>
<% end %>


<script type="text/javascript">

  $(document).ready( function(){
  
  function drawGraph(abs, val, namec, namecont, couleur) {
    var c = $(namec);
    var ctx = c.get(0).getContext('2d');
    var container = $(c).parent();
    c.attr('width', $(container).width() ); //max width
    c.attr('height', 480*$(container).width()/900.0); //max height
    document.getElementById(namecont).style.height = 480*$(container).width()/900.0 + "px"
    
    //Redraw & reposition content
    var x = c.width();
    var y = c.height();

    var pct = c.width()/900.0;

    ctx.beginPath();
    ctx.rect(pct*50, pct*5, pct*806, pct*450);
    ctx.fillStyle = 'white';
    ctx.fill();
    ctx.lineWidth = 1.5;
    ctx.strokeStyle = 'black';
    ctx.stroke();
    
    // Affichage des barres horizontales
    
    var maxivisitor = 0;
    for(i = 0; i < val.length; i++) {
      if(maxivisitor < val[i]) {
        maxivisitor = val[i];
      }
    }
    var maxi = 1.15*maxivisitor;
    
    var tranche = Math.floor(maxivisitor/4);
    if(tranche == 0){
      tranche = 1;
    }
    
    ctx.lineWidth = 0.5;
    ctx.strokeStyle = 'grey';
    ctx.font="14px Arial";
    ctx.fillStyle = 'black';
    ctx.textAlign = 'right';

    ctx.setLineDash([10, 10]);
    ctx.beginPath();
  
    if (pct < 0.7){
      ctx.font="9px Arial";
    }
  
    var encours = Math.floor(maxivisitor);
  
    while(encours > 0) {
      var haut = 450 - 450*(encours/maxi);
      if(haut < 0) {
        haut = 0;
      }
      ctx.moveTo(pct*50, pct*(haut+5));
      ctx.lineTo(pct*856, pct*(haut+5));
      ctx.fillText(encours,pct*44,pct*(haut+10));
      encours = encours - tranche;
    }
  
    ctx.font="14px Arial";

    ctx.stroke();
    ctx.setLineDash([]);
    
    // On trace maintenant le graphique
    ctx.strokeStyle = 'black';

    // Commencement du graphique

    // On parcourt de droite à gauche
    encours = val.length-1;
  
    ctx.fillStyle = couleur;
    ctx.strokeStyle = couleur;
    ctx.font = "12px Arial";
    ctx.textAlign = 'center';
    ctx.lineWidth = 3;
    ctx.beginPath();
  
    while(encours >= 0) {
      var w = 3 + 800*encours/(val.length-1);
      var huser = 450 - 450*(val[encours]/maxi);
      if(encours == 0) {
        ctx.moveTo(pct*(50+w), pct*(huser+5));
      }
      else {
        ctx.lineTo(pct*(50+w), pct*(huser+5));
      }
      encours = encours-1;
    }  
    ctx.stroke();
    
    ctx.fillStyle = 'black';
    ctx.lineWidth = 0.5;
    ctx.strokeStyle = 'grey';
    
    ctx.setLineDash([10, 10]);
    ctx.beginPath();

    encours = val.length-1;
    var printw = 10000;
    
    while(encours >= 0) {
      var w = 3 + 800*encours/(val.length-1);
      if((w < printw - 50 && pct > 0.8) || (w < printw - 100 && pct > 0.7)) {
        ctx.fillText(abs[encours],pct*(50+w),pct*471);
        printw = w;
        ctx.moveTo(pct*(50+w), pct*5);
        ctx.lineTo(pct*(50+w), pct*455);
      }
      encours = encours-1;
    }
  
    ctx.stroke();
    ctx.setLineDash([]);
  }

  //Run function when browser  resize
  $(window).resize( respondCanvas );
  
  <% t2 = Time.now %>

  function respondCanvas(){
    <!-- Graphique de la fréquentation -->
    var xxx = [];
    var yyy = [];
    <% xx = Array.new %>
    <% yy = Array.new %>
    <% @visiteurs = Visitor.order("date").to_a %>
    <% premierjour = @visiteurs[0].date %>
    <% dernierjour = DateTime.now.in_time_zone.to_date - 1 %>
    <% prev = premierjour %>
    <% if premierjour < dernierjour %>
      <% @visiteurs = @visiteurs.take @visiteurs.size()-1 %>
      <% @visiteurs.each do |v| %>
        <% ((prev+1)..(v.date-1)).each do |missing| %>
          <% yy.push(0) %>
          <% xx.push(convert_date(missing)) %>
        <% end %>
        <% yy.push(v.number_user + v.number_admin) %>
        <% xx.push(convert_date(v.date)) %>
        <% prev = v.date %>
      <% end %>
      <% ((prev+1)..dernierjour).each do |missing| %>
        <% yy.push(0) %>
          <% xx.push(convert_date(missing)) %>
      <% end %>
      xxx = <%= ruby_to_javascript_string(xx) %>;
      yyy = <%= ruby_to_javascript(yy) %>;
      drawGraph(xxx, yyy, '#myCanvas1', 'contenant1', 'orange');
      
      <% t3 = Time.now %>
      
      <% yy = [] %>
      <% xx = [] %>
      <% lastweek = convert_to_week(DateTime.now.in_time_zone.to_date) %>
      <% (0..(lastweek-1)).each do |i| %>
        <% yy[i] = 0 %>
        <% xx.push(convert_date(@premierlundi+7*i)) %>
      <% end %>
      <% yy[lastweek] = 0 %>
      <% t4 = Time.now %>
      <% Solvedexercise.select("updated_at").where(:correct => true).each do |s| %>
        <% w = convert_to_week(s.updated_at.to_date) %>
        <% yy[w] = yy[w]+1 %>
      <% end %>
      <% t5 = Time.now %>
      <% Solvedqcm.select("updated_at").where(:correct => true).each do |s| %>
        <% w = convert_to_week(s.updated_at.to_date) %>
        <% yy[w] = yy[w]+1 %>
      <% end %>
      xxx = <%= ruby_to_javascript_string(xx[0..-1]) %>;
      yyy = <%= ruby_to_javascript(yy[0..-2]) %>;
      drawGraph(xxx, yyy, '#myCanvas2', 'contenant2', 'blue');
      
      <% t6 = Time.now %>
      
      <% yy = [] %>
      <% (0..(lastweek-1)).each do |i| %>
        <% yy[i] = 0 %>
      <% end %>
      <% yy[lastweek] = 0 %>
      <% Submission.select("created_at").all.each do |s| %>
        <% w = convert_to_week(s.created_at.to_date) %>
        <% yy[w] = yy[w]+1 %>
      <% end %>
      yyy = <%= ruby_to_javascript(yy[0..-2]) %>;
      drawGraph(xxx, yyy, '#myCanvas3', 'contenant3', 'red');
    <% end %>
    
    <% t7 = Time.now %>
  }

  //Initial call
  respondCanvas();

  });

</script>

<% if montretemps == 1 %>
  <br/>Temps de chargement : <%= t2-t1 %>, <%= t3-t2 %>, <%= t4-t3 %>, <%= t5-t4 %>, <%= t6-t5 %>, <%= t7-t6 %> secondes.
<% end %>
