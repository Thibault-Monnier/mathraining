<script type="text/javascript">
var reserve = function () {
  $.getScript("<%= reserve_url(:submission_id => @submission) %>");
}
var unreserve = function () {
  $.getScript("<%= unreserve_url(:submission_id => @submission) %>");
}
</script>

<!-- Enlève la notification de l'étudiant s'il faut -->
<% if @submission.user == current_user.sk %>
	<% notif = current_user.sk.notifs.where(submission_id: @submission.id) %>
	<% if notif.size > 0 && !current_user.other %>
  	<% notif.first.delete %>
	<% end %>
<% end %>

<% if @submission.status >= 0 %>
<h3>Soumission
<% case @submission.status %>
<% when 0 %>
  (en attente de correction)
<% when 1, 3 %>
  (erronée)
<% when 2 %>
  (correcte)
  <% if @submission.star %>
    <%= image_tag @submission.icon %>
  <% end %>
<% end %>
</h3>
<% else %>
<h3>Brouillon</h3>
<% end %>

<!-- Si administrateur, on propose de réserver la soumission -->
<% @unactivate = 0 %>
<% reservation_case = 0 %>
<% corrector_name = "" %>
<% if current_user.sk != @submission.user && @submission.status == 0 && @submission.visible %>
  <% f = @submission.followings.first %>
  <% if f.nil? %>
    <% reservation_case = 1 %>
    <% @unactivate = 1 %>
  <% elsif f.user == current_user.sk %>
    <% reservation_case = 3 %>
  <% else %>
    <% reservation_case = 2 %>
    <% @unactivate = 2 %>
    <% corrector_name = f.user.name %>
  <% end %>
  
  <div id="correct1" style="background-color:#fffad2; padding:10px; border:1px solid #dddddd;
; <%= "display:none;" if reservation_case != 1 %>">
    Avant de corriger cette soumission, prévenez les autres que vous vous en occupez !
    <div class="visible-xs" style="height:7px;"></div>
    <button class="btn btn-default btn-grey" style="margin-left:30px;" onclick="javascript:reserve()" <%= "disabled='disabled'" if current_user.other %>>Réserver cette soumission</button>
  </div>
  
  <div id="correct2" style="background-color:#ffd9de; padding:10px; border:1px solid #dddddd; <%= "display:none;" if reservation_case != 2 %>">
    Cette soumission est en train d'être corrigée par <b><%= corrector_name %></b>.
  </div>
  
  <div id="correct3" style="background-color:#d7efd9; padding:10px; border:1px solid #dddddd; <%= "display:none;" if reservation_case != 3 %>">
    Vous avez réservé cette soumission pour la corriger.
    <div class="visible-xs" style="height:7px;"></div>
    <button class="btn btn-default btn-grey" style="margin-left:30px;" onclick="javascript:unreserve()" <%= "disabled='disabled'" if current_user.other %>>Annuler ma soumission</button>
  </div>
<% end %>

<!-- Si étudiant et soumission non correcte -->
<% if (@submission.status == 1 || @submission.status == 3) && current_user.sk == @submission.user %>
  Vous pouvez tenter de corriger cette solution en postant un commentaire, ou soumettre une nouvelle solution.
<% end %>

<!-- Affichage de la soumission -->
<%= render 'subjects/content', ms: @submission, kind: "submission" %>

<!-- Si soumission en test avec score, on affiche le score -->
<% if @submission.intest && @submission.score != -1 && (current_user.sk.admin? || current_user.sk == @submission.user) %>
<h4>Score obtenu</h4>
<center><div style="padding:3px; font-size:24px; border:1px solid orange; background-color:#FFFFCC;"><%= @submission.score %> / 7</span></center><br/>
<% end %>

<!-- Affichage des corrections -->
<% if @submission.status >= 0 %>
  <%= render 'corrections/index' %>
<% end %>

<!-- Marquer comme lu ou non lu -->
<% if current_user.sk.admin || (current_user.sk.corrector && @resolu && current_user.sk != @submission.user) %>
  <!-- <% following = Following.find_by_user_id_and_submission_id(current_user.sk, @submission) %> NE MARCHE PLUS -->
  <% following = Following.where(:user_id => current_user.sk, :submission_id => @submission).first %>
    <% if !following.nil? && following.read && @submission.status != 0 %>
      <center><%= link_to 'Marquer comme non lu', problem_submission_unread_path(@problem, @submission), :class => "btn btn-default btn-grey", :disabled => current_user.other %></center>
    <% elsif !following.nil? && @submission.status != 0 %>
      <center><%= link_to 'Marquer comme lu', problem_submission_read_path(@problem, @submission), :class => "btn btn-default btn-grey", :disabled => current_user.other %></center>
    <% end %>
<% end %>

<!-- Formulaire pour nouvelle correction -->
<% if current_user.sk.admin? && !@submission.visible && @submission.intest %>
  Cette soumission fait partie d'un test virtuel qui n'est pas terminé. Vous ne pourrez la corriger qu'une fois le temps de celui-ci écoulé.
<% elsif !current_user.sk.admin? && current_user.sk == @submission.user && @submission.intest && @submission.score == -1 %>
  Cette solution fait partie d'un test et n'a pas encore été corrigée. Vous pourrez la commenter une fois que cela aura été fait.
<% elsif (current_user.sk.admin? || current_user.sk == @submission.user || (current_user.sk.corrector && @resolu)) && @submission.status >= 0 %>
  <%= render 'corrections/new' %>
<% end %>

<!-- Supprimer la soumission : pas possible si correcte -->
<% if current_user.sk.admin? && @submission.status != 2 && @submission.status >= 0 %>
  <br/><center>
  <%= link_to 'Supprimer cette soumission', @submission, method: :delete, data: { confirm: "Êtes-vous sûr de vouloir supprimer cette soumission ? Ne faites-cela que si celle-ci n'est pas vraiment une soumission (par exemple si l'étudiant signale une erreur)." }, :style => "color:red;" %>
  </center>
<% end %>

<!-- Marquer la soumission comme élégante -->
<% if (current_user.sk.admin? || (current_user.sk.corrector? && @resolu && @submission.user != current_user.sk)) && @submission.status == 2 %>
  <br/><center>
    <% if @submission.star %>
      <center><%= link_to 'Ne plus marquer comme élégant', problem_submission_unstar_path(@problem, @submission), :class => "btn btn-default btn-grey", :disabled => current_user.other %></center>
    <% else %>
      <center><%= link_to 'Marquer comme élégant', problem_submission_star_path(@problem, @submission), :class => "btn btn-default btn-grey", :disabled => current_user.other %></center>
    <% end %>
  </center>
<% end %>
